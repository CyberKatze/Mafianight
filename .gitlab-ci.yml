stages:
  - setup
  - prepare
  - test
  - build

variables:
  YESOD_PGUSER: $YESOD_PGUSER
  YESOD_PGPASS: $YESOD_PGPASS
  YESOD_PGHOST: $YESOD_PGHOST
  YESOD_PGPORT: $YESOD_PGPORT
  YESOD_PGPORT_TEST: $YESOD_PGPORT_TEST
  YESOD_PGDATABASE: $YESOD_PGDATABASE
  YESOD_PGDATABASE_TEST: $YESOD_PGDATABASE_TEST
  SECRET: $SECRET
  SALT: $SALT

test_backend:
  stage: setup
  script:
    - docker compose -f server/docker-compose.yml up -d db-test
    - echo $YESOD_PGPORT
    - docker compose -f server/docker-compose.yml ps
    - nix develop -c bash -c "export YESOD_PGUSER=\$YESOD_PGUSER YESOD_PGPASS=\$YESOD_PGPASS YESOD_PGHOST=\$YESOD_PGHOST YESOD_PGPORT=\$YESOD_PGPORT YESOD_PGPORT_TEST=\$YESOD_PGPORT_TEST YESOD_PGDATABASE=\$YESOD_PGDATABASE YESOD_PGDATABASE_TEST=\$YESOD_PGDATABASE_TEST SECRET=\$SECRET SALT=$SALT && make test-back"

